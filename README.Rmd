---
title: "Introduction to ARMET"
author: "Stefano Mangiola"
date: "6/25/2021"
output: html_document
---
---
title: "sccomp - Outlier-aware and count-based compositional analysis of single-cell data"
output: github_document
always_allow_html: true
---

<!-- badges: start -->
[![Lifecycle:maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing) [![R build status](https://github.com/stemangiola/tidyseurat/workflows/R-CMD-check/badge.svg)](https://github.com/stemangiola/tidyseurat/actions/)
<!-- badges: end -->

#  <img src="inst/logo-01.png" height="139px" width="120px" />

```{r echo=FALSE}
knitr::opts_chunk$set( fig.path = "man/figures/")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(sccomp)
library(ggplot2)
library(forcats)
library(tidyr)
data("ACC")
```

# Installation

```{r eval=FALSE}
devtools::install_github("stemangiola/sccomp")
```

# Usage

```{r}

# prior_survival_time = 
# 	read_csv("dev/survival_TCGA_curated.csv") %>% 
# 				filter(PFI.2==1 & !is.na(PFI.time.2) & PFI.time.2 != "#N/A") %>%
# 				pull(PFI.time.2) %>% 
# 				as.numeric

prior_survival_time = ACC %>% filter(!alive) %>% distinct(patient, time) %>% pull(time)

# my_formula = F %>% when((.) ~ ~ censored(PFI.time.2, alive) * gender, ~ ~ censored(PFI.time.2, alive))
# 
# my_df = readRDS("dev/armet_TCGA_June7_2021_fixed_regression/armet_ACC_input.rds") %>%
# # Do gender
# ARMET_tc(
# # model = stan_model("~/PhD/deconvolution/ARMET/inst/stan/ARMET_tc_fix_hierarchical.stan"),
# my_formula,
# patient,
# transcript,
# count,
# cores = 4,
# prior_survival_time = read_csv("dev/survival_TCGA_curated.csv") %>% filter(PFI.2==1 & !is.na(PFI.time.2) & PFI.time.2 != "#N/A") %>% pull(PFI.time.2) %>% as.numeric,
# transform_time_function =sqrt
# )


armet_obj = 	
	ACC %>%
	setup_convolved_lm(
		~ censored(time, alive),
			.sample = patient,
			.transcript = transcript,
			.abundance = count, 
			prior_survival_time = prior_survival_time, 
			transform_time_function = sqrt
	)

armet_estimate = 
	armet_obj %>% 
	estimate_convoluted_lm_1() %>% 
	estimate_convoluted_lm_2() %>% 
	estimate_convoluted_lm_3() %>% 
	estimate_convoluted_lm_4() 
```

Plotting

```{r}

ACC = readRDS("/stornext/Bioinf/data/bioinf-data/Papenfuss_lab/projects/mangiola.s/ARMET_dev/dev/armet_ACC_input.rds")

```